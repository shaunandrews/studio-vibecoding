# Preview Bug Fixes — February 17, 2026

## Summary
Fired up the dev server to test seed site rendering. Found and fixed four issues preventing the preview from working correctly.

## Bugs Fixed

### 1. Page slug mismatch — "Preview Error: Page '/' not found"
Both seed sites define homepage slug as `""` (empty string), but SitePreview initializes `currentPage` to `"/"`. The renderer did an exact match, so `"/" !== ""` failed for every page.

**Fix:** Normalize slugs in the renderer — strip leading slashes and treat `"/"` as `""` before matching. Applied to both `renderSite()` and the new `getPageData()`. Also fixed the `pages` computed in SitePreview to map both `""` and `"/"` to `'homepage'`.

### 2. Nav links in iframe didn't navigate
Seed sites use standard `<a href="/menu">` links, but the iframe listener script only caught `data-navPage` attribute clicks.

**Fix:** Added anchor tag interception to the click handler — any `<a>` with an internal href (starts with `/`, not `//`) gets intercepted and sent as a `navigate` postMessage.

### 3. Font flash (FOUT) on every page navigation
Every navigation replaced the entire `srcdoc`, which destroyed the iframe document and forced Google Fonts to re-download/re-parse. Even with HTTP caching, the new browsing context caused a visible flash.

**Fix:** Switched to in-place page swapping via postMessage. The iframe document loads once (via `srcdoc`) and stays alive. Subsequent navigations send a `page-update` message that swaps section styles and body content without reloading the document. Fonts, theme CSS, and the listener script persist.

New exports: `getPageData()` (extracts section data for a page) and `sendPageUpdate()` (sends page-update postMessage to iframe).

### 4. Default body margin on iframe
Browser default `body { margin: 8px }` caused visible gap around the preview content.

**Fix:** Added `body { margin: 0 }` reset to the rendered document's `<head>`.

### 5. Page titles included site name suffix
Seed data had titles like "Menu | Downstreet Cafe" but the renderer already appends `- {site.name}` to the `<title>` tag, causing double naming. The BrowserBar dropdown also showed the full compound title.

**Fix:** Simplified seed data titles to just the page name ("Home", "Menu", "About", "Work").

## Files Changed
- `src/data/site-renderer.ts` — Slug normalization, anchor interception, page-update handler, body margin reset, getPageData/sendPageUpdate exports
- `src/components/features/SitePreview.vue` — postMessage-based navigation, iframe ref, srcdoc only on initial load, slug normalization in pages computed
- `src/data/seed-sites/downstreet-cafe.ts` — Simplified page titles
- `src/data/seed-sites/portfolio.ts` — Simplified page titles

---

## Wire Generation Loop into New Project Flow

### Summary
Connected the new project creation flow to the AI generation engine. Previously, creating a new project resulted in a dead end — `startBuild()` was a stub that only console.logged. Now it triggers the full Extract Loop generation pipeline.

### What Changed

**`useBuildProgress.ts` — Full rewrite (was stub)**
- Maps `ProjectType` → page configs (section roles per page, per project type)
- Calls `useGeneration().generateSite()` with the right parameters
- Tracks per-project build state via reactive `buildStates` map
- `isBuilding()` now returns real state (was always `false`)
- Updates project status to `'running'` on success, `'stopped'` on error
- Supports `stopBuild()` via the generation abort controller

**`ProjectPage.vue` — Cleanup**
- Removed `usePipeline` import and dead `pipelineState`/`skeletonSlots` props
- SitePreview only receives `projectId` (which is all it needs)

**`AgentPanel.vue` — Cleanup**
- Removed `usePipeline` import and dead `updateContext` reference
- Removed context-extraction setTimeout code that depended on the pipeline stub

**`SitePreview.vue` — Reactive generation updates**
- Split site watcher into two: identity change (full srcdoc reload) vs content mutation (postMessage update)
- Deep watcher on site content sends `page-update` via postMessage as sections arrive, avoiding font flash during generation
- Falls back to srcdoc if iframe isn't ready yet

### Data Flow (now working)
```
OnboardingChat → ProjectBrief
  → MainLayout.onProjectCreated(brief)
  → createProject(brief) → Project in store
  → router.push(project)
  → startBuild(projectId, brief)
  → PAGE_CONFIGS[brief.type] → pageConfigs
  → generateSite(projectId, name, type, description, pageConfigs)
  → setSite() → initial site structure in store → SitePreview renders
  → updateSection() × N → sections appear progressively in preview
  → setStatus('running') on completion
```

### Files Changed
- `src/data/useBuildProgress.ts` — Full rewrite from stub
- `src/pages/ProjectPage.vue` — Removed usePipeline
- `src/components/features/AgentPanel.vue` — Removed usePipeline, dead context code
- `src/components/features/SitePreview.vue` — Deep watcher for generation updates

---

## First Live Test — Generation UX Fixes

### Summary
First live test of the generation loop revealed four issues. All addressed.

### Issues Fixed

**1. Section response parsing too brittle**
AI doesn't always return the exact `` ```section:sectionId `` fence format. Parser now tries multiple fallbacks:
- Exact `section:id` fence (original)
- Any `section:*` fence (AI renamed the section)
- Separate ` ```css` + ` ```html` blocks
- CSS/HTML split by `---` separator with flexible whitespace
- Last resort: split on first HTML tag

**2. Preview scroll-jacking during generation**
Every section update triggered `page-update` which scrolled to top. Added `preserveScroll` option to the page-update postMessage protocol. The deep site watcher in SitePreview uses `preserveScroll: true` so generation updates don't disrupt scrolling. Navigation still scrolls to top.

**3. No build progress indication**
Added a build status banner to AgentPanel. Shows a pulsing dot and reactive status label with section count ("Building Home... (3/12 sections)"). Uses the `progress` ref from `useGeneration` via `useBuildProgress`.

**4. Section parsing error for store type**
"Section product-grid not found in response" — addressed by the more resilient parser (issue 1). The AI was likely returning the content in a slightly different fence format.

### Files Changed
- `src/data/generation/useGeneration.ts` — Resilient section response parser
- `src/data/site-renderer.ts` — `preserveScroll` option on page-update
- `src/components/features/SitePreview.vue` — preserveScroll in deep watcher
- `src/components/features/AgentPanel.vue` — Build progress banner
